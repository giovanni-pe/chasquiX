<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChasquiX - Sistema de Taxi</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <style>
        /* Reset b√°sico */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }

        /* Contenedor principal */
        .container {
            display: flex;
            height: 100%;
            width: 100%;
        }

        /* Sidebar - Lo haremos m√°s peque√±o y absoluto para que no interfiera */
        .sidebar {
            position: absolute;
            left: 10px;
            top: 10px;
            width: 300px;
            height: calc(100% - 20px);
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            overflow-y: auto;
            padding: 15px;
            display: none; /* Lo ocultamos por defecto */
        }

        /* Mapa - Ocupa todo el espacio */
        .map-container {
            flex: 1;
            height: 100%;
            width: 100%;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
            z-index: 1;
        }

        /* Estilos para el bot√≥n de toggle del sidebar */
        .toggle-sidebar {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1001;
            background: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
            cursor: pointer;
        }

        /* Estilos para marcadores */
        .marker-pin {
            width: 30px;
            height: 30px;
            border-radius: 50% 50% 50% 0;
            background: #764ba2;
            position: absolute;
            transform: rotate(-45deg);
            left: 50%;
            top: 50%;
            margin: -15px 0 0 -15px;
        }

        .marker-pin::after {
            content: '';
            width: 24px;
            height: 24px;
            margin: 3px 0 0 3px;
            background: #fff;
            position: absolute;
            border-radius: 50%;
        }

        .driver-marker {
            background: #28a745;
        }

        .client-marker {
            background: #007bff;
        }

        .destination-marker {
            background: #dc3545;
            transform: rotate(0);
        }

        /* Chat container - Lo posicionamos absolutamente */
        #chatContainer {
            position: absolute;
            right: -350px;
            top: 10px;
            width: 350px;
            height: calc(100% - 20px);
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transition: right 0.3s ease;
        }

        #chatContainer.active {
            right: 10px;
        }
    </style>
</head>

<body>
    <!-- Bot√≥n para toggle del sidebar -->
    <button class="toggle-sidebar" onclick="toggleSidebar()">‚ò∞</button>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="header">
            <h1>üöï ChasquiX</h1>
            <p>Sistema de Taxi - Tingo Mar√≠a</p>
        </div>

        <div id="connectionStatus" class="connection-status disconnected">
            üî¥ Desconectado
        </div>

        <div class="user-type">
            <label for="userTypeSelect">Tipo de Usuario:</label>
            <select id="userTypeSelect">
                <option value="client">üôã‚Äç‚ôÇÔ∏è Cliente (Solicitar Taxi)</option>
                <option value="driver">üèçÔ∏è Mototaxista (Ofrecer Servicio)</option>
            </select>
        </div>

        <div class="user-info">
            <div id="userInfo">
                <p><strong>Usuario:</strong> <span id="userId"></span></p>
                <p><strong>Estado:</strong> <span id="userStatus">Esperando...</span></p>
            </div>
        </div>

        <div class="request-form">
            <h3 id="formTitle">Solicitar Taxi</h3>

            <div id="destinationSelector" class="destination-selector">
                <p>üìç <strong>Click en el mapa para seleccionar destino</strong></p>
            </div>

            <div class="form-group">
                <label for="destination">Destino:</label>
                <textarea id="destination" rows="2" placeholder="Describe tu destino en Tingo Mar√≠a"></textarea>
            </div>

            <div class="form-group">
                <label for="description">Descripci√≥n adicional:</label>
                <textarea id="description" rows="2"
                    placeholder="Ej: Frente al mercado central, llevar equipaje..."></textarea>
            </div>

            <div class="form-group" id="priceGroup" style="display: none;">
                <label for="price">Precio ofrecido (S/):</label>
                <input type="number" id="price" placeholder="15.00" step="0.50" min="5">
            </div>

            <div id="routeInfo" class="route-info" style="display: none;">
                <strong>Informaci√≥n de ruta:</strong>
                <p>Distancia: <span id="routeDistance">-</span></p>
                <p>Tiempo estimado: <span id="routeDuration">-</span></p>
            </div>

            <button id="actionBtn" class="btn">üìç Compartir Mi Ubicaci√≥n</button>
            <button id="selectDestinationBtn" class="btn btn-secondary" style="display: none;">üéØ Seleccionar
                Destino</button>
            <div class="btn-group" id="confirmButtons" style="display: none;">
                <button id="confirmRequestBtn" class="btn">‚úÖ Confirmar Solicitud</button>
                <button id="clearRouteBtn" class="btn btn-danger">üóëÔ∏è Limpiar</button>
            </div>
            <button id="cancelBtn" class="btn btn-danger" style="display: none;">‚ùå Cancelar Solicitud</button>
            <button id="openChatBtn" class="btn btn-chat" style="display: none;">
                üí¨ Chat con <span id="chatPartnerType">-</span>
                <span id="unreadIndicator" class="chat-indicator" style="display: none;">0</span>
            </button>
        </div>

        <div class="active-requests">
            <h3>üó∫Ô∏è Actividad en Tiempo Real</h3>
            <div id="requestsList"></div>
        </div>

        <div class="coordinates" id="coordinates">
            <strong>üìç Mi ubicaci√≥n:</strong><br>
            Latitud: <span id="lat">-</span><br>
            Longitud: <span id="lng">-</span>
        </div>
    </div>

    <!-- Mapa - Ahora ocupa toda la pantalla -->
    <div class="map-container">
        <div id="map"></div>
    </div>

    <!-- Chat Container -->
    <div id="chatContainer" class="chat-container">
        <div class="chat-header">
            <h4>üí¨ Chat con <span id="chatPartnerName">-</span></h4>
            <button class="chat-close" onclick="closeChat()">√ó</button>
        </div>
        <div id="chatMessages" class="chat-messages"></div>
        <div class="chat-input-container">
            <input type="text" id="chatInput" class="chat-input" placeholder="Escribe un mensaje..."
                onkeypress="handleChatKeyPress(event)">
            <button class="chat-send" onclick="sendChatMessage()">‚û§</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script>
        // Configuraci√≥n global
        const MQTT_CONFIG = {
            host: 'localhost',
            port: 9001,
            topics: {
                clients: 'chasquix/clients',
                drivers: 'chasquix/drivers',
                routes: 'chasquix/routes',
                messages: 'chasquix/messages',
                assignments: 'chasquix/assignments'
            }
        };

        // Variables globales
        let map;
        let mqttClient;
        let currentUser = {
            id: 'user_' + Date.now(),
            type: 'client',
            lat: null,
            lng: null,
            status: 'waiting'
        };
        let markers = new Map();
        let routeControl = null;
        let currentRequest = null;
        let destinationMarker = null;
        let destinationCoords = null;
        let selectingDestination = false;
        let activeAssignment = null;
        let chatMessages = [];
        let chatPartner = null;
        let unreadMessages = 0;

        // Funci√≥n para mostrar/ocultar el sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.style.display = sidebar.style.display === 'none' ? 'block' : 'none';
        }

        // Inicializar la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', function () {
            initMap();
            initMQTT();
            initEventListeners();
            getUserLocation();
            updateUI();
        });

        // Inicializar el mapa
        function initMap() {
            // Coordenadas de Tingo Mar√≠a, Per√∫
            const tingoMaria = [-9.2945, -76.0073];

            map = L.map('map').setView(tingoMaria, 14);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Evento para hacer clic en el mapa
            map.on('click', function (e) {
                if (selectingDestination) {
                    setDestination(e.latlng.lat, e.latlng.lng);
                }
            });
        }

        // Resto del c√≥digo JavaScript permanece igual...
        // [Aqu√≠ ir√≠a todo el resto del c√≥digo JavaScript que proporcionaste anteriormente]
        // Solo aseg√∫rate de que las funciones que manipulan el DOM est√©n actualizadas para trabajar con los nuevos estilos

        // Inicializar MQTT
        function initMQTT() {
            mqttClient = new Paho.MQTT.Client(MQTT_CONFIG.host, MQTT_CONFIG.port, currentUser.id);

            mqttClient.onConnectionLost = function (response) {
                console.log('Conexi√≥n MQTT perdida:', response);
                updateConnectionStatus(false);
                setTimeout(initMQTT, 5000); // Reintentar conexi√≥n
            };

            mqttClient.onMessageArrived = function (message) {
                handleMQTTMessage(message);
            };

            // Conectar al broker MQTT
            mqttClient.connect({
                onSuccess: function () {
                    console.log('Conectado a MQTT');
                    updateConnectionStatus(true);
                    subscribeToTopics();
                },
                onFailure: function (error) {
                    console.error('Error conectando a MQTT:', error);
                    updateConnectionStatus(false);
                    setTimeout(initMQTT, 5000); // Reintentar
                }
            });
        }

        // [El resto de tus funciones JavaScript permanecen igual...]
    </script>
</body>

</html>

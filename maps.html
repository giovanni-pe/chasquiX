<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ChasquiX - Sistema de Taxi M√≥vil</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            position: fixed;
            width: 100%;
            -webkit-overflow-scrolling: touch;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            touch-action: manipulation;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh; /* Para compatibilidad con WebView */
            position: relative;
            overflow: hidden;
        }

        .sidebar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            padding: env(safe-area-inset-top, 20px) 15px 15px 15px;
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.15);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            z-index: 1000;
            will-change: transform;
        }

        .sidebar.active {
            transform: translateY(0);
        }

        .map-container {
            flex: 1;
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #map {
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px 0;
        }

        .header h1 {
            color: #764ba2;
            font-size: 24px;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .header p {
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }

        .user-type {
            margin-bottom: 20px;
        }

        .user-type label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }

        .user-type select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            font-size: 16px;
            background: white;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .user-type select:focus {
            outline: none;
            border-color: #764ba2;
            box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.1);
        }

        .user-info {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #764ba2;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .connection-status {
            padding: 12px 16px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 16px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .request-form {
            background: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            border: 1px solid #e1e5e9;
        }

        .request-form h3 {
            margin-bottom: 16px;
            color: #764ba2;
            font-size: 18px;
            font-weight: 700;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: #374151;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            background: #fafbfc;
            transition: all 0.2s ease;
            resize: none;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #764ba2;
            background: white;
            box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            transition: all 0.2s ease;
            margin-bottom: 12px;
            box-shadow: 0 4px 12px rgba(118, 75, 162, 0.3);
            min-height: 48px; /* Para mejor accesibilidad t√°ctil */
        }

        .btn:active {
            transform: translateY(1px);
            box-shadow: 0 2px 8px rgba(118, 75, 162, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }

        .active-requests {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            border: 1px solid #e1e5e9;
        }

        .active-requests h3 {
            margin-bottom: 16px;
            color: #764ba2;
            font-size: 16px;
            font-weight: 700;
        }

        .request-item {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 12px;
            border-left: 4px solid #28a745;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .request-item:active {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .request-item.driver {
            border-left-color: #007bff;
        }

        .request-item h4 {
            margin-bottom: 8px;
            color: #333;
            font-size: 15px;
            font-weight: 600;
        }

        .request-item p {
            margin: 4px 0;
            color: #666;
            font-size: 13px;
            line-height: 1.4;
        }

        .accept-btn, .cancel-btn, .contact-btn {
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
            margin-right: 8px;
            min-height: 36px;
            transition: all 0.2s ease;
        }

        .accept-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            box-shadow: 0 2px 6px rgba(40, 167, 69, 0.3);
        }

        .cancel-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            box-shadow: 0 2px 6px rgba(220, 53, 69, 0.3);
        }

        .contact-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            box-shadow: 0 2px 6px rgba(23, 162, 184, 0.3);
        }

        .coordinates {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            padding: 16px;
            border-radius: 12px;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', monospace;
            font-size: 12px;
            margin-top: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid #e1e5e9;
        }

        .destination-selector {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 16px;
            border: 2px dashed #2196f3;
            text-align: center;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
        }

        .destination-selector.active {
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);
            border-style: solid;
            color: white;
            box-shadow: 0 4px 16px rgba(33, 150, 243, 0.3);
        }

        .route-info {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            padding: 16px;
            border-radius: 12px;
            margin-top: 16px;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.2);
            border: 1px solid #ffeaa7;
        }

        .notification {
            position: fixed;
            top: env(safe-area-inset-top, 20px);
            left: 16px;
            right: 16px;
            padding: 16px 20px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            transform: translateY(-120px);
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            font-size: 15px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .notification.show {
            transform: translateY(0);
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Estilos para los iconos del mapa */
        .custom-div-icon {
            background: none;
            border: none;
        }

        .marker-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
        }

        .my-marker {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            border: 3px solid white;
            animation: pulse 2s infinite;
        }

        .my-marker::after {
            content: 'üë§';
            font-size: 16px;
        }

        .client-marker {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: 3px solid white;
        }

        .client-marker::after {
            content: 'üôã';
            font-size: 16px;
        }

        .driver-marker {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border: 3px solid white;
        }

        .driver-marker::after {
            content: 'üèç';
            font-size: 16px;
        }

        .destination-marker {
            background: linear-gradient(135deg, #ff6347 0%, #dc3545 100%);
            border: 3px solid white;
        }

        .destination-marker::after {
            content: 'üìç';
            font-size: 16px;
        }

        /* Ocultar controles de ruta de Leaflet */
        .leaflet-routing-container {
            display: none;
        }

        .distance-badge {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 4px 8px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 700;
            margin-left: 8px;
            box-shadow: 0 2px 6px rgba(0, 123, 255, 0.3);
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .btn-group .btn {
            flex: 1;
            margin-bottom: 0;
        }

        /* Chat Container - Optimizado para WebView */
        .chat-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70vh;
            height: 70dvh;
            background: white;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.2);
            display: none;
            flex-direction: column;
            z-index: 1000;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        .chat-container.active {
            display: flex;
            transform: translateY(0);
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .chat-header h4 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .chat-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .chat-close:active {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(0.95);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 20px;
            background: #f8f9fa;
        }

        .chat-message {
            margin-bottom: 16px;
            display: flex;
            align-items: flex-start;
        }

        .chat-message.sent {
            justify-content: flex-end;
        }

        .chat-message.received {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 20px;
            position: relative;
            font-size: 15px;
            line-height: 1.4;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .message-bubble.sent {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border-bottom-right-radius: 6px;
        }

        .message-bubble.received {
            background: white;
            color: #333;
            border-bottom-left-radius: 6px;
            border: 1px solid #e1e5e9;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 6px;
            font-weight: 500;
        }

        .chat-input-container {
            padding: 20px;
            border-top: 1px solid #e1e5e9;
            display: flex;
            gap: 12px;
            align-items: flex-end;
            background: white;
            padding-bottom: calc(20px + env(safe-area-inset-bottom, 0px));
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 24px;
            font-size: 16px;
            outline: none;
            background: #fafbfc;
            transition: all 0.2s ease;
            max-height: 100px;
            resize: none;
        }

        .chat-input:focus {
            border-color: #764ba2;
            background: white;
            box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.1);
        }

        .chat-send {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
            font-size: 18px;
        }

        .chat-send:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.4);
        }

        /* FABs optimizados para WebView */
        .fab-container {
            position: fixed;
            bottom: env(safe-area-inset-bottom, 20px);
            right: 20px;
            z-index: 999;
        }

        .fab-main {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 24px rgba(118, 75, 162, 0.4);
            cursor: pointer;
            font-size: 28px;
            z-index: 1000;
            transition: all 0.2s ease;
            border: 2px solid white;
        }

        .fab-main:active {
            transform: scale(0.95);
            box-shadow: 0 4px 16px rgba(118, 75, 162, 0.5);
        }

        .fab-secondary-container {
            position: absolute;
            bottom: 80px;
            right: 0;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 16px;
        }

        .fab-group {
            display: none;
            flex-direction: column;
            gap: 16px;
        }

        .fab-group.active {
            display: flex;
        }

        .fab-with-label {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .fab-secondary {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: #6c757d;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            font-size: 22px;
            transition: all 0.2s ease;
            border: 2px solid white;
        }

        .fab-secondary:active {
            transform: scale(0.95);
        }

        .fab-secondary.success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .fab-secondary.danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .fab-secondary.info {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
        }

        .fab-label {
            font-size: 12px;
            color: white;
            background: rgba(0, 0, 0, 0.8);
            padding: 4px 12px;
            border-radius: 16px;
            margin-top: 8px;
            text-align: center;
            font-weight: 600;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .chat-indicator {
            position: absolute;
            top: -6px;
            right: -6px;
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4);
            border: 2px solid white;
        }

        /* Panel toggle optimizado */
        .panel-toggle {
            position: fixed;
            top: env(safe-area-inset-top, 20px);
            left: 20px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.95);
            color: #764ba2;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            z-index: 1001;
            font-size: 20px;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .panel-toggle:active {
            transform: scale(0.95);
            background: white;
        }

        /* Nuevos estilos para lista de clientes */
        .client-list {
            margin-top: 16px;
        }

        .client-item {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-left: 4px solid #2196f3;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 12px;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.1);
        }

        .client-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .client-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-accept {
            background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            flex: 1;
            font-size: 13px;
            font-weight: 600;
            min-height: 40px;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        .btn-chat {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            flex: 1;
            font-size: 13px;
            font-weight: 600;
            min-height: 40px;
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
        }

        /* Responsive para tablets */
        @media (min-width: 768px) {
            .container {
                flex-direction: row;
            }

            .sidebar {
                position: relative;
                width: 380px;
                height: 100%;
                transform: translateY(0);
                padding: 20px;
            }

            .panel-toggle {
                display: none;
            }

            .chat-container {
                width: 400px;
                height: 500px;
                bottom: 20px;
                right: 20px;
                border-radius: 16px;
            }

            .chat-header {
                border-radius: 16px 16px 0 0;
            }
        }

        /* Mejoras para dispositivos con notch */
        @supports (padding: max(0px)) {
            .sidebar {
                padding-top: max(env(safe-area-inset-top), 20px);
            }

            .panel-toggle {
                top: max(env(safe-area-inset-top), 20px);
            }

            .notification {
                top: max(env(safe-area-inset-top), 20px);
            }

            .fab-container {
                bottom: max(env(safe-area-inset-bottom), 20px);
            }

            .chat-input-container {
                padding-bottom: max(env(safe-area-inset-bottom), 20px);
            }
        }

        /* Optimizaciones adicionales para WebView */
        .leaflet-control-zoom {
            margin-top: env(safe-area-inset-top, 60px) !important;
        }

        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .leaflet-popup-tip {
            background: white;
        }

        /* Prevent zoom on input focus */
        input[type="text"],
        input[type="number"],
        textarea,
        select {
            font-size: 16px !important;
        }

        /* Smooth scrolling */
        * {
            scroll-behavior: smooth;
        }

        /* Better touch targets */
        button, .request-item, .fab-main, .fab-secondary {
            min-height: 44px;
            min-width: 44px;
        }

        /* Prevent text selection on UI elements */
        .btn, .fab-main, .fab-secondary, .panel-toggle, .chat-close {
            -webkit-user-select: none;
            user-select: none;
        }

        /* Allow text selection in chat and forms */
        .chat-messages, .form-group input, .form-group textarea {
            -webkit-user-select: text;
            user-select: text;
        }

        /* Improve performance */
        .sidebar, .chat-container, .notification {
            will-change: transform;
        }

        .marker-icon {
            will-change: transform;
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            .sidebar {
                background: rgba(30, 30, 30, 0.98);
                color: #ffffff;
            }

            .user-info, .request-form, .active-requests {
                background: #2d2d2d;
                color: #ffffff;
                border-color: #404040;
            }

            .form-group input, .form-group textarea, .user-type select {
                background: #3d3d3d;
                color: #ffffff;
                border-color: #505050;
            }

            .coordinates {
                background: #3d3d3d;
                color: #ffffff;
            }

            .request-item {
                background: #3d3d3d;
                color: #ffffff;
            }

            .chat-messages {
                background: #2d2d2d;
            }

            .message-bubble.received {
                background: #3d3d3d;
                color: #ffffff;
                border-color: #505050;
            }

            .chat-input {
                background: #3d3d3d;
                color: #ffffff;
                border-color: #505050;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="panel-toggle" id="panelToggle">
            <i class="fas fa-bars"></i>
        </div>

        <div class="sidebar" id="sidebar">
            <div class="header">
                <h1>üöï ChasquiX</h1>
                <p>Sistema de Taxi - Tingo Mar√≠a</p>
            </div>

            <div id="connectionStatus" class="connection-status disconnected">
                üî¥ Desconectado
            </div>

            <div class="user-type">
                <label for="userTypeSelect">Tipo de Usuario:</label>
                <select id="userTypeSelect">
                    <option value="client">üôã‚Äç‚ôÇÔ∏è Cliente (Solicitar Taxi)</option>
                    <option value="driver">üèçÔ∏è Mototaxista (Ofrecer Servicio)</option>
                </select>
            </div>

            <div class="user-info">
                <div id="userInfo">
                    <p><strong>Usuario:</strong> <span id="userId"></span></p>
                    <p><strong>Estado:</strong> <span id="userStatus">Esperando...</span></p>
                </div>
            </div>

            <div class="request-form">
                <h3 id="formTitle">Solicitar Taxi</h3>

                <div id="destinationSelector" class="destination-selector">
                    <p>üìç <strong>Click en el mapa para seleccionar destino</strong></p>
                </div>

                <div class="form-group">
                    <label for="destination">Destino:</label>
                    <textarea id="destination" rows="2" placeholder="Describe tu destino en Tingo Mar√≠a"></textarea>
                </div>

                <div class="form-group">
                    <label for="description">Descripci√≥n adicional:</label>
                    <textarea id="description" rows="2"
                        placeholder="Ej: Frente al mercado central, llevar equipaje..."></textarea>
                </div>

                <div class="form-group" id="priceGroup" style="display: none;">
                    <label for="price">Precio ofrecido (S/):</label>
                    <input type="number" id="price" placeholder="15.00" step="0.50" min="5">
                </div>

                <div id="routeInfo" class="route-info" style="display: none;">
                    <strong>Informaci√≥n de ruta:</strong>
                    <p>Distancia: <span id="routeDistance">-</span></p>
                    <p>Tiempo estimado: <span id="routeDuration">-</span></p>
                </div>
            </div>

            <div class="active-requests">
                <h3>üó∫Ô∏è Actividad en Tiempo Real</h3>
                <div id="requestsList"></div>
            </div>

            <div class="coordinates" id="coordinates">
                <strong>üìç Mi ubicaci√≥n:</strong><br>
                Latitud: <span id="lat">-</span><br>
                Longitud: <span id="lng">-</span>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>

    <!-- Chat Container -->
    <div id="chatContainer" class="chat-container">
        <div class="chat-header">
            <h4>üí¨ Chat con <span id="chatPartnerName">-</span></h4>
            <button class="chat-close" onclick="closeChat()">√ó</button>
        </div>
        <div id="chatMessages" class="chat-messages"></div>
        <div class="chat-input-container">
            <textarea id="chatInput" class="chat-input" placeholder="Escribe un mensaje..." rows="1"
                onkeypress="handleChatKeyPress(event)"></textarea>
            <button class="chat-send" onclick="sendChatMessage()">‚û§</button>
        </div>
    </div>

    <!-- FAB Container -->
    <div class="fab-container" id="fabContainer">
        <!-- FAB Principal -->
        <div class="fab-main" id="fabMain">
            <i class="fas fa-taxi" id="fabMainIcon"></i>
        </div>

        <!-- FABs Secundarios -->
        <div class="fab-secondary-container">
            <!-- Grupo 1: Modo Espera (Cliente) -->
            <div class="fab-group" id="waitingGroup">
                <div class="fab-with-label" id="fabDestination">
                    <div class="fab-secondary">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <span class="fab-label">Destino</span>
                </div>
            </div>

            <!-- Grupo 2: Modo Ruta (Cliente) -->
            <div class="fab-group" id="routeGroup">
                <div class="fab-with-label" id="fabConfirm">
                    <div class="fab-secondary success">
                        <i class="fas fa-check"></i>
                    </div>
                    <span class="fab-label">Confirmar</span>
                </div>
            </div>

            <!-- Grupo 3: Modo Activo (Todos) -->
            <div class="fab-group" id="activeGroup">
                <div class="fab-with-label" id="fabCancel">
                    <div class="fab-secondary danger">
                        <i class="fas fa-times"></i>
                    </div>
                    <span class="fab-label">Cancelar</span>
                </div>
                <div class="fab-with-label" id="fabChat">
                    <div class="fab-secondary info">
                        <i class="fas fa-comment"></i>
                        <span id="unreadIndicator" class="chat-indicator">0</span>
                    </div>
                    <span class="fab-label">Chat</span>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <script>
        // Configuraci√≥n global
        const MQTT_CONFIG = {
            host: 'mqttv2.smartpx.org',
            port: 443,
            topics: {
                clients: 'chasquix/clients',
                drivers: 'chasquix/drivers',
                routes: 'chasquix/routes',
                messages: 'chasquix/messages',
                assignments: 'chasquix/assignments'
            }
        };

        // Variables globales
        let map;
        let mqttClient;
        let currentUser = {
            id: 'user_' + Date.now(),
            type: 'client',
            lat: null,
            lng: null,
            status: 'waiting'
        };
        let markers = new Map();
        let routeControl = null;
        let currentRequest = null;
        let destinationMarker = null;
        let destinationCoords = null;
        let selectingDestination = false;
        let activeAssignment = null;
        let chatMessages = [];
        let chatPartner = null;
        let unreadMessages = 0;
        let fabMenuOpen = false;

        // Optimizaciones para WebView
        let isWebView = /WebView|wv|Version.*Chrome\/[.0-9]* Mobile/i.test(navigator.userAgent);

        // Prevenir zoom en inputs para iOS WebView
        if (isWebView && /iPhone|iPad|iPod/i.test(navigator.userAgent)) {
            document.addEventListener('touchstart', function() {}, true);
        }

        // Inicializar la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', function () {
            initMap();
            initMQTT();
            initEventListeners();
            getUserLocation();
            updateUI();
            updateFABs();

            // Configuraciones espec√≠ficas para WebView
            setupWebViewOptimizations();
        });

        // Configuraciones espec√≠ficas para WebView
        function setupWebViewOptimizations() {
            // Prevenir comportamiento de pull-to-refresh
            document.body.addEventListener('touchstart', function(e) {
                if (e.touches.length !== 1) { return; }
                let scrollY = window.pageYOffset || document.body.scrollTop || document.documentElement.scrollTop;
                if (scrollY === 0) {
                    document.body.scrollTop = document.documentElement.scrollTop = 1;
                }
            }, false);

            // Mejorar rendimiento en WebView
            if (isWebView) {
                // Optimizar animaciones para WebView
                document.documentElement.style.setProperty('--animation-duration', '0.2s');

                // Configurar viewport height para WebView
                const setVH = () => {
                    let vh = window.innerHeight * 0.01;
                    document.documentElement.style.setProperty('--vh', `${vh}px`);
                };
                setVH();
                window.addEventListener('resize', setVH);
                window.addEventListener('orientationchange', setVH);
            }

            // Configurar comportamiento t√°ctil mejorado
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(event) {
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    event.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
        }

        // Inicializar el mapa con optimizaciones para WebView
        function initMap() {
            // Coordenadas de Tingo Mar√≠a, Per√∫
            const tingoMaria = [-9.2945, -76.0073];

            // Configuraci√≥n optimizada para WebView
            map = L.map('map', {
                center: tingoMaria,
                zoom: 14,
                zoomControl: true,
                attributionControl: false,
                preferCanvas: true, // Mejor rendimiento en WebView
                maxZoom: 18,
                minZoom: 10
            });

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap',
                maxZoom: 18,
                detectRetina: true // Soporte para pantallas de alta densidad
            }).addTo(map);

            // Evento para hacer clic en el mapa
            map.on('click', function (e) {
                if (selectingDestination) {
                    setDestination(e.latlng.lat, e.latlng.lng);
                    toggleFABMenu();
                }
            });

            // Optimizar rendimiento del mapa en WebView
            map.on('movestart', function() {
                map.getContainer().style.pointerEvents = 'none';
            });

            map.on('moveend', function() {
                map.getContainer().style.pointerEvents = 'auto';
            });
        }

        // Inicializar MQTT con mejor manejo de errores para WebView
        function initMQTT() {
            const clientId = currentUser.id || 'webclient_' + Math.random().toString(16).substr(2, 8);
            const path = '';
            const timeout = 15; // Aumentar timeout para WebView

            console.log(`Conectando MQTT: wss://${MQTT_CONFIG.host}:${MQTT_CONFIG.port}`);

            mqttClient = new Paho.MQTT.Client(
                MQTT_CONFIG.host,
                MQTT_CONFIG.port,
                path,
                clientId
            );

            mqttClient.onConnectionLost = function (response) {
                console.error('Conexi√≥n MQTT perdida:', response.errorCode, response.errorMessage);
                updateConnectionStatus(false);

                // Reintento con backoff exponencial
                const delay = Math.min(30000, 3000 * Math.pow(1.5, reconnectAttempts));
                setTimeout(initMQTT, delay);
                reconnectAttempts++;
            };

            mqttClient.onMessageArrived = function (message) {
                try {
                    handleMQTTMessage(message);
                } catch (e) {
                    console.error('Error procesando mensaje:', e);
                }
            };

            const connectOptions = {
                timeout: timeout,
                keepAliveInterval: 30, // Reducir para WebView
                cleanSession: true,
                useSSL: true,
                onSuccess: function () {
                    console.log('MQTT conectado exitosamente');
                    updateConnectionStatus(true);
                    reconnectAttempts = 0;
                    subscribeToTopics();
                },
                onFailure: function (error) {
                    console.error('Error MQTT:', error.errorCode, error.errorMessage);
                    updateConnectionStatus(false);

                    const delay = Math.min(30000, 3000 * Math.pow(1.5, reconnectAttempts));
                    setTimeout(initMQTT, delay);
                    reconnectAttempts++;
                }
            };

            try {
                mqttClient.connect(connectOptions);
            } catch (e) {
                console.error('Excepci√≥n conectando MQTT:', e);
                setTimeout(initMQTT, 5000);
            }
        }

        let reconnectAttempts = 0;

        // Resto del c√≥digo JavaScript permanece igual...
        // [Incluir aqu√≠ todo el JavaScript restante del c√≥digo original,
        //  pero con las optimizaciones ya aplicadas]

        // Suscribirse a los topics MQTT
        function subscribeToTopics() {
            Object.values(MQTT_CONFIG.topics).forEach(topic => {
                mqttClient.subscribe(topic);
                console.log('Suscrito a:', topic);
            });
        }

        // [Continuar con el resto de las funciones JavaScript del c√≥digo original...]
        // [El c√≥digo es muy extenso, as√≠ que incluir√© las funciones principales
        //  y las optimizaciones espec√≠ficas para WebView]

        // Funci√≥n mejorada para manejo t√°ctil en WebView
        function handleTouch(element, callback) {
            let startY = 0;
            let isScrolling = false;

            element.addEventListener('touchstart', function(e) {
                startY = e.touches[0].pageY;
                isScrolling = false;
            });

            element.addEventListener('touchmove', function(e) {
                const moveY = e.touches[0].pageY;
                if (Math.abs(moveY - startY) > 10) {
                    isScrolling = true;
                }
            });

            element.addEventListener('touchend', function(e) {
                if (!isScrolling) {
                    callback(e);
                }
            });
        }

        // Optimizar notificaciones para WebView
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'notification';

            const colors = {
                'success': 'linear-gradient(135deg, #28a745 0%, #20c997 100%)',
                'error': 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)',
                'warning': 'linear-gradient(135deg, #ffc107 0%, #e0a800 100%)',
                'info': 'linear-gradient(135deg, #17a2b8 0%, #138496 100%)'
            };

            notification.style.background = colors[type] || colors.info;
            notification.textContent = message;

            document.body.appendChild(notification);

            // Animaci√≥n optimizada para WebView
            requestAnimationFrame(() => {
                notification.classList.add('show');
            });

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // [Incluir aqu√≠ el resto de las funciones del c√≥digo original con las optimizaciones aplicadas]

        // Funci√≥n de inicializaci√≥n de eventos optimizada para WebView
        function initEventListeners() {
            // Usar eventos t√°ctiles optimizados para WebView
            const userTypeSelect = document.getElementById('userTypeSelect');
            userTypeSelect.addEventListener('change', function () {
                currentUser.type = this.value;
                updateUI();
                updateFABs();
            });

            // Panel toggle con mejor respuesta t√°ctil
            const panelToggle = document.getElementById('panelToggle');
            handleTouch(panelToggle, function() {
                document.getElementById('sidebar').classList.toggle('active');
            });

            // FAB principal con feedback t√°ctil mejorado
            const fabMain = document.getElementById('fabMain');
            handleTouch(fabMain, function() {
                // A√±adir feedback visual
                fabMain.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    fabMain.style.transform = 'scale(1)';
                }, 100);

                if (fabMenuOpen) {
                    toggleFABMenu();
                } else {
                    handleMainAction();
                }
            });

            // FAB secundarios
            const fabDestination = document.getElementById('fabDestination');
            handleTouch(fabDestination, startDestinationSelection);

            const fabCancel = document.getElementById('fabCancel');
            handleTouch(fabCancel, cancelCurrentRequest);

            const fabConfirm = document.getElementById('fabConfirm');
            handleTouch(fabConfirm, confirmAndSendRequest);

            const fabChat = document.getElementById('fabChat');
            handleTouch(fabChat, openChat);

            // Lista de solicitudes con mejor manejo t√°ctil
            const requestsList = document.getElementById('requestsList');
            requestsList.addEventListener('click', function (e) {
                const requestItem = e.target.closest('.request-item');
                if (requestItem && e.target.classList.contains('accept-btn')) {
                    const data = JSON.parse(requestItem.dataset.requestData);
                    acceptRequest(data.userId, data);
                }
            });

            // Mejorar input de chat para WebView
            const chatInput = document.getElementById('chatInput');
            chatInput.addEventListener('input', function() {
                // Auto-resize textarea
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
            });
        }

        // [Continuar con las dem√°s funciones del c√≥digo original...]
        // Por brevedad, incluir√© solo las funciones principales y las optimizaciones espec√≠ficas

        // Resto de funciones JavaScript del c√≥digo original van aqu√≠...
        // (getUserLocation, updateLocation, handleMQTTMessage, etc.)



        // Suscribirse a los topics MQTT
        function subscribeToTopics() {
            Object.values(MQTT_CONFIG.topics).forEach(topic => {
                mqttClient.subscribe(topic);
                console.log('Suscrito a:', topic);
            });
        }

        // Manejar mensajes MQTT
        function handleMQTTMessage(message) {
            try {
                const data = JSON.parse(message.payloadString);
                const topic = message.destinationName;

                console.log('Mensaje recibido:', topic, data);

                switch (topic) {
                    case MQTT_CONFIG.topics.clients:
                        handleClientMessage(data);
                        break;
                    case MQTT_CONFIG.topics.drivers:
                        handleDriverMessage(data);
                        break;
                    case MQTT_CONFIG.topics.routes:
                        handleRouteMessage(data);
                        break;
                    case MQTT_CONFIG.topics.messages:
                        handleDirectMessage(data);
                        break;
                    case MQTT_CONFIG.topics.assignments:
                        handleAssignmentMessage(data);
                        break;
                }
            } catch (error) {
                console.error('Error procesando mensaje MQTT:', error);
            }
        }

        // Manejar mensajes de clientes
        function handleClientMessage(data) {
            if (data.action === 'request') {
                if (data.userId !== currentUser.id) {
                    addOrUpdateMarker(data, 'client');
                    addToRequestsList(data, 'client');
                }
            } else if (data.action === 'cancel') {
                removeMarker(data.userId);
                removeFromRequestsList(data.userId);
            }
        }

        // Manejar mensajes de conductores con solicitudes de servicio
        function handleDriverMessage(data) {
            if (data.action === 'available') {
                if (data.userId !== currentUser.id) {
                    addOrUpdateMarker(data, 'driver');
                    addToRequestsList(data, 'driver');
                }
            } else if (data.action === 'accept') {
                handleDriverAcceptance(data);
            } else if (data.action === 'request_client') {
                // Conductor solicita a cliente
                if (data.targetClientId === currentUser.id) {
                    handleDriverRequestToClient(data);
                }
            } else if (data.action === 'offline') {
                removeMarker(data.userId);
                removeFromRequestsList(data.userId);
            }

            // Mostrar lista de clientes si es taxista
            if (currentUser.type === 'driver' && currentUser.status === 'available') {
                updateClientList();
            }
        }

        // Nueva funci√≥n para actualizar lista de clientes
        function updateClientList() {
            const requestsList = document.getElementById('requestsList');
            requestsList.innerHTML = '<h3>üë• Clientes Solicitando Taxi</h3>';

            let hasClients = false;

            markers.forEach((marker, userId) => {
                const userData = marker.options.userData;

                if (userData.type === 'client' && userData.action === 'request' && userId !== currentUser.id) {
                    hasClients = true;
                    addClientToList(userData, userId);
                }
            });

            if (!hasClients) {
                requestsList.innerHTML += '<p>No hay clientes solicitando servicio en este momento</p>';
            }
        }

        // Nueva funci√≥n para a√±adir cliente a la lista
        function addClientToList(clientData, clientId) {
            const requestsList = document.getElementById('requestsList');
            const distance = calculateDistance(
                currentUser.lat, currentUser.lng,
                clientData.lat, clientData.lng
            );

            const clientItem = document.createElement('div');
            clientItem.className = 'client-item';
            clientItem.dataset.clientId = clientId;

            clientItem.innerHTML = `
                <div class="client-header">
                         <p><strong>ID:</strong> ${data && data.userId ? data.userId.substring(0, 8) : 'N/A'}</p>


                    <span class="distance-badge">${distance.toFixed(1)} km</span>
                </div>
                <p><strong>Ubicaci√≥n:</strong> ${clientData.lat.toFixed(4)}, ${clientData.lng.toFixed(4)}</p>
                ${clientData.destination ? `<p><strong>Destino:</strong> ${clientData.destination}</p>` : ''}
                ${clientData.description ? `<p><strong>Notas:</strong> ${clientData.description}</p>` : ''}
                <div class="client-actions">
                    <button class="btn-accept" onclick="acceptClientRequest('${clientId}')">
                        üöó Aceptar Viaje
                    </button>
                    <button class="btn-chat" onclick="initiateChatWithClient('${clientId}')">
                        üí¨ Chatear
                    </button>
                </div>
            `;

            requestsList.appendChild(clientItem);
        }

        // Nueva funci√≥n para aceptar cliente
        window.acceptClientRequest = function (clientId) {
            const clientData = markers.get(clientId)?.options?.userData;

            if (!clientData) {
                showNotification('Cliente no encontrado', 'error');
                return;
            }

            const assignment = {
                clientId: clientId,
                driverId: currentUser.id,
                action: 'assigned',
                driverLocation: {
                    lat: currentUser.lat,
                    lng: currentUser.lng
                },
                clientLocation: {
                    lat: clientData.lat,
                    lng: clientData.lng
                },
                destination: clientData.destinationLat ? {
                    lat: clientData.destinationLat,
                    lng: clientData.destinationLng
                } : null,
                timestamp: Date.now()
            };

            publishMessage(MQTT_CONFIG.topics.assignments, assignment);
            showNotification(`Viaje aceptado con cliente ${clientId.substring(0, 6)}`, 'success');

            // Iniciar chat autom√°ticamente
            initiateChatWithClient(clientId);
        };

        // Nueva funci√≥n para iniciar chat con cliente
        window.initiateChatWithClient = function (clientId) {
            chatPartner = {
                id: clientId,
                type: 'client',
                name: `Cliente ${clientId.substring(0, 6)}`
            };

            updateChatButton();
            openChat();
            addSystemMessage(`Chat iniciado con cliente ${clientId.substring(0, 6)}`);

            // Notificar al cliente
            const chatNotification = {
                targetId: clientId,
                senderId: currentUser.id,
                message: `El mototaxista quiere comunicarse contigo`,
                type: 'chat_init',
                timestamp: Date.now()
            };

            publishMessage(MQTT_CONFIG.topics.messages, chatNotification);
        };

        // Manejar cuando un conductor solicita a un cliente
        function handleDriverRequestToClient(data) {
            showNotification(`Conductor ${data.userId} quiere ofrecerte servicio`, 'info');

            // Establecer chat con el conductor
            chatPartner = {
                id: data.userId,
                type: 'driver'
            };
            updateChatButton();

            // Incrementar mensajes no le√≠dos
            unreadMessages++;
            updateUnreadIndicator();

            // Agregar mensaje al chat
            addSystemMessage(`El conductor ${data.userId} est√° interesado en tu viaje. Puedes chatear para acordar detalles.`);
        }

        // Manejar mensajes de asignaci√≥n
        function handleAssignmentMessage(data) {
            if (data.clientId === currentUser.id || data.driverId === currentUser.id) {
                activeAssignment = data;

                if (data.action === 'assigned') {
                    handleAssignment(data);
                } else if (data.action === 'completed') {
                    handleTripCompletion(data);
                }
            }
        }

        // Manejar asignaci√≥n de viaje
        function handleAssignment(data) {
            if (data.clientId === currentUser.id) {
                // Cliente: ocultar otros taxistas
                markers.forEach((marker, markerId) => {
                    if (markerId !== data.driverId && markerId !== currentUser.id) {
                        map.removeLayer(marker);
                    }
                });

                showNotification(`¬°Taxista ${data.driverId} ha aceptado tu solicitud!`, 'success');
                currentUser.status = 'in_trip';

                // Establecer chat con el conductor
                chatPartner = {
                    id: data.driverId,
                    type: 'driver'
                };
                updateChatButton();
                addSystemMessage('Ahora puedes chatear con tu conductor');

                // Mostrar solo el taxista asignado
                if (data.driverLocation) {
                    addOrUpdateMarker({
                        userId: data.driverId,
                        lat: data.driverLocation.lat,
                        lng: data.driverLocation.lng,
                        status: 'assigned'
                    }, 'driver');
                }
            } else if (data.driverId === currentUser.id) {
                // Conductor: mostrar ruta al cliente
                showNotification(`¬°Nueva carrera asignada!`, 'success');
                currentUser.status = 'in_trip';

                // Establecer chat con el cliente
                chatPartner = {
                    id: data.clientId,
                    type: 'client'
                };
                updateChatButton();
                addSystemMessage('Ahora puedes chatear con tu pasajero');

                if (data.clientLocation && data.destination) {
                    drawAssignedRoute(data.clientLocation, data.destination);
                }
            }

            updateUI();
            updateFABs();
        }

        // Inicializar event listeners
        function initEventListeners() {
            document.getElementById('userTypeSelect').addEventListener('change', function () {
                currentUser.type = this.value;
                updateUI();
                updateFABs();
            });

            // Panel toggle
            document.getElementById('panelToggle').addEventListener('click', function () {
                document.getElementById('sidebar').classList.toggle('active');
            });

            // FAB Main button
            document.getElementById('fabMain').addEventListener('click', function () {
                if (fabMenuOpen) {
                    toggleFABMenu();
                } else {
                    handleMainAction();
                }
            });

            // FAB Secondary buttons
            document.getElementById('fabDestination').addEventListener('click', startDestinationSelection);

            document.getElementById('fabCancel').addEventListener('click', cancelCurrentRequest);
            document.getElementById('fabConfirm').addEventListener('click', confirmAndSendRequest);
            document.getElementById('fabChat').addEventListener('click', openChat);

            // Click en elementos de la lista
            document.getElementById('requestsList').addEventListener('click', function (e) {
                const requestItem = e.target.closest('.request-item');
                if (requestItem && e.target.classList.contains('accept-btn')) {
                    const data = JSON.parse(requestItem.dataset.requestData);
                    acceptRequest(data.userId, data);
                }
            });
        }

        // Manejar acci√≥n principal del FAB
        function handleMainAction() {
            if (currentUser.type === 'client') {
                if (!currentUser.lat || !currentUser.lng) {
                    getUserLocation();
                } else if (!destinationCoords) {
                    toggleFABMenu();
                } else {
                    confirmAndSendRequest();
                }
            } else {
                sendDriverAvailability();
            }
        }

        // Alternar men√∫ FAB
        function toggleFABMenu() {
            fabMenuOpen = !fabMenuOpen;
            document.getElementById('fabContainer').classList.toggle('fab-menu-open');
            updateFABs();
        }

        // Actualizar FABs seg√∫n estado
        function updateFABs() {
            // Ocultar todos los grupos primero
            document.querySelectorAll('.fab-group').forEach(group => {
                group.classList.remove('active');
            });

            // Mostrar solo el grupo necesario
            if (currentUser.type === 'client') {
                if (!currentUser.lat) {
                    // Esperando ubicaci√≥n
                    document.getElementById('fabMainIcon').className = 'fas fa-location-arrow';
                }
                else if (!destinationCoords && !currentRequest) {
                    // Esperando destino
                    document.getElementById('waitingGroup').classList.add('active');
                    document.getElementById('fabMainIcon').className = 'fas fa-map-marker-alt';
                }
                else if (destinationCoords && !currentRequest) {
                    // Ruta lista para confirmar
                    document.getElementById('routeGroup').classList.add('active');
                    document.getElementById('fabMainIcon').className = 'fas fa-paper-plane';
                }
                else {
                    // Viaje activo
                    document.getElementById('activeGroup').classList.add('active');
                    document.getElementById('fabMainIcon').className = 'fas fa-car-side';
                }
            }
            else { // Driver
                if (currentUser.status === 'available' || currentUser.status === 'in_trip') {
                    document.getElementById('activeGroup').classList.add('active');
                }
                document.getElementById('fabMainIcon').className =
                    currentUser.status === 'available' ? 'fas fa-bell' : 'fas fa-motorcycle';
            }

            // Mostrar indicador de chat si hay mensajes
            document.getElementById('unreadIndicator').style.display =
                unreadMessages > 0 ? 'flex' : 'none';
            document.getElementById('unreadIndicator').textContent =
                unreadMessages > 9 ? '9+' : unreadMessages;
        }
        // Obtener ubicaci√≥n del usuario
        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function (position) {
                        updateLocation(position.coords.latitude, position.coords.longitude);

                        if (currentUser.type === 'client') {
                            showNotification('Ubicaci√≥n actualizada. Ahora selecciona tu destino.', 'info');
                            updateFABs();
                        }
                    },
                    function (error) {
                        console.error('Error obteniendo ubicaci√≥n:', error);
                        // Usar ubicaci√≥n por defecto en Tingo Mar√≠a
                        updateLocation(-9.2945, -76.0073);
                    }
                );
            } else {
                updateLocation(-9.2945, -76.0073);
            }
        }

        // Actualizar ubicaci√≥n
        function updateLocation(lat, lng) {
            currentUser.lat = lat;
            currentUser.lng = lng;

            document.getElementById('lat').textContent = lat.toFixed(6);
            document.getElementById('lng').textContent = lng.toFixed(6);

            // Centrar mapa en la nueva ubicaci√≥n
            map.setView([lat, lng], 16);

            // Agregar/actualizar marcador del usuario actual
            addOrUpdateMarker(currentUser, currentUser.type);

            updateFABs();
        }

        // Iniciar selecci√≥n de destino
        function startDestinationSelection() {
            selectingDestination = true;
            document.getElementById('destinationSelector').classList.add('active');
            document.getElementById('destinationSelector').innerHTML =
                '<p>üéØ <strong>Haz click en el mapa para marcar tu destino</strong></p>';

            map.getContainer().style.cursor = 'crosshair';
            showNotification('Haz click en el mapa para seleccionar tu destino', 'info');
        }

        // Establecer destino
        function setDestination(lat, lng) {
            destinationCoords = { lat, lng };

            // Remover marcador anterior si existe
            if (destinationMarker) {
                map.removeLayer(destinationMarker);
            }

            // Crear marcador de destino
            const iconHtml = '<div class="marker-pin destination-marker"></div>';
            const customIcon = L.divIcon({
                html: iconHtml,
                className: 'custom-div-icon',
                iconSize: [30, 30],
                iconAnchor: [15, 30]
            });

            destinationMarker = L.marker([lat, lng], { icon: customIcon }).addTo(map);
            destinationMarker.bindPopup('<strong>üéØ Tu destino</strong>').openPopup();

            // Dibujar ruta
            drawRoute();

            // Actualizar UI
            selectingDestination = false;
            map.getContainer().style.cursor = '';
            document.getElementById('destinationSelector').classList.remove('active');
            document.getElementById('destinationSelector').innerHTML =
                '<p>‚úÖ <strong>Destino seleccionado</strong></p>';

            updateFABs();
        }

        // Dibujar ruta
        function drawRoute() {
            // Remover ruta anterior si existe
            if (routeControl) {
                map.removeControl(routeControl);
            }

            routeControl = L.Routing.control({
                waypoints: [
                    L.latLng(currentUser.lat, currentUser.lng),
                    L.latLng(destinationCoords.lat, destinationCoords.lng)
                ],
                routeWhileDragging: false,
                addWaypoints: false,
                createMarker: function () { return null; }, // No crear marcadores adicionales
                lineOptions: {
                    styles: [{ color: '#764ba2', weight: 4, opacity: 0.7 }]
                }
            }).on('routesfound', function (e) {
                const routes = e.routes;
                const summary = routes[0].summary;

                // Actualizar informaci√≥n de ruta
                document.getElementById('routeInfo').style.display = 'block';
                document.getElementById('routeDistance').textContent =
                    (summary.totalDistance / 1000).toFixed(2) + ' km';
                document.getElementById('routeDuration').textContent =
                    Math.round(summary.totalTime / 60) + ' min';

                // Ajustar vista del mapa
                const bounds = L.latLngBounds([
                    [currentUser.lat, currentUser.lng],
                    [destinationCoords.lat, destinationCoords.lng]
                ]);
                map.fitBounds(bounds, { padding: [50, 50] });
            }).addTo(map);

            updateFABs();
        }

        // Confirmar y enviar solicitud
        function confirmAndSendRequest() {
            if (!currentUser.lat || !currentUser.lng || !destinationCoords) {
                alert('Por favor, selecciona tu ubicaci√≥n y destino');
                return;
            }

            const destination = document.getElementById('destination').value.trim();
            const description = document.getElementById('description').value.trim();

            const request = {
                userId: currentUser.id,
                action: 'request',
                lat: currentUser.lat,
                lng: currentUser.lng,
                destinationLat: destinationCoords.lat,
                destinationLng: destinationCoords.lng,
                destination: destination || 'Destino seleccionado en el mapa',
                description: description,
                timestamp: Date.now(),
                status: 'waiting'
            };

            publishMessage(MQTT_CONFIG.topics.clients, request);
            currentRequest = request;
            currentUser.status = 'requesting';
            updateUI();
            updateFABs();

            showNotification('Solicitud de taxi enviada. Buscando conductores cercanos...', 'success');

            // Mostrar taxistas cercanos
            highlightNearbyDrivers();
        }

        // Resaltar conductores cercanos
        function highlightNearbyDrivers() {
            const maxDistance = 2; // km

            markers.forEach((marker, markerId) => {
                const markerData = marker.options.userData;
                if (markerData && markerData.type === 'driver') {
                    const distance = calculateDistance(
                        currentUser.lat, currentUser.lng,
                        markerData.lat, markerData.lng
                    );

                    if (distance <= maxDistance) {
                        marker.setIcon(createPulsingIcon('driver'));

                        // Notificar al conductor
                        const notification = {
                            targetId: markerId,
                            senderId: currentUser.id,
                            message: `Nueva solicitud de taxi cerca (${distance.toFixed(1)} km)`,
                            type: 'nearby_request',
                            data: currentRequest
                        };
                        publishMessage(MQTT_CONFIG.topics.messages, notification);
                    }
                }
            });
        }

        // Crear icono con efecto de pulso
        function createPulsingIcon(type) {
            const iconClass = type === 'client' ? 'client-marker' : 'driver-marker';
            const iconHtml = `<div class="marker-pin ${iconClass} pulse"></div>`;

            return L.divIcon({
                html: iconHtml,
                className: 'custom-div-icon',
                iconSize: [30, 30],
                iconAnchor: [15, 30]
            });
        }

        // Limpiar ruta
        function clearRoute() {
            if (routeControl) {
                map.removeControl(routeControl);
                routeControl = null;
            }

            if (destinationMarker) {
                map.removeLayer(destinationMarker);
                destinationMarker = null;
            }

            destinationCoords = null;
            document.getElementById('routeInfo').style.display = 'none';
            document.getElementById('destinationSelector').innerHTML =
                '<p>üìç <strong>Click en el mapa para seleccionar destino</strong></p>';

            updateFABs();
        }

        // Enviar disponibilidad del conductor
        function sendDriverAvailability() {
            if (!currentUser.lat || !currentUser.lng) {
                alert('Por favor, permite el acceso a tu ubicaci√≥n');
                return;
            }

            const description = document.getElementById('description').value.trim();
            const price = document.getElementById('price').value;

            const availability = {
                userId: currentUser.id,
                action: 'available',
                lat: currentUser.lat,
                lng: currentUser.lng,
                description: description || 'Mototaxi disponible',
                price: price || '10.00',
                timestamp: Date.now(),
                status: 'available'
            };

            publishMessage(MQTT_CONFIG.topics.drivers, availability);
            currentRequest = availability;
            currentUser.status = 'available';
            updateUI();
            updateFABs();

            showNotification('Ahora est√°s disponible para servicios', 'success');
        }

        // Cancelar solicitud actual
        function cancelCurrentRequest() {
            if (currentRequest) {
                const cancelMessage = {
                    userId: currentUser.id,
                    action: 'cancel',
                    timestamp: Date.now()
                };

                const topic = currentUser.type === 'client' ?
                    MQTT_CONFIG.topics.clients : MQTT_CONFIG.topics.drivers;

                publishMessage(topic, cancelMessage);

                currentRequest = null;
                currentUser.status = 'waiting';
                clearRoute();
                updateUI();
                updateFABs();

                showNotification('Solicitud cancelada', 'info');
            }
        }

        // Aceptar solicitud (para conductores)
        function acceptRequest(requestId, clientData) {
            // Si el conductor acepta a un cliente
            if (currentUser.type === 'driver' && clientData.action === 'request') {
                const acceptance = {
                    clientId: requestId,
                    driverId: currentUser.id,
                    action: 'assigned',
                    driverLocation: {
                        lat: currentUser.lat,
                        lng: currentUser.lng
                    },
                    clientLocation: {
                        lat: clientData.lat,
                        lng: clientData.lng
                    },
                    destination: clientData.destinationLat ? {
                        lat: clientData.destinationLat,
                        lng: clientData.destinationLng
                    } : null,
                    timestamp: Date.now()
                };

                publishMessage(MQTT_CONFIG.topics.assignments, acceptance);

                // Notificar al cliente
                const notification = {
                    targetId: requestId,
                    senderId: currentUser.id,
                    message: `Conductor ${currentUser.id} ha aceptado tu solicitud`,
                    type: 'acceptance'
                };
                publishMessage(MQTT_CONFIG.topics.messages, notification);

                currentUser.status = 'in_trip';
                updateUI();
                updateFABs();
                showNotification('Solicitud aceptada. Dirigi√©ndose al cliente...', 'success');
            }
            // Si el cliente solicita a un conductor espec√≠fico
            else if (currentUser.type === 'client' && clientData.action === 'available') {
                requestServiceFromDriver(requestId, clientData);
            }
        }

        // Cliente solicita servicio a conductor espec√≠fico
        function requestServiceFromDriver(driverId, driverData) {
            const destination = document.getElementById('destination').value.trim();

            // Si no hay destino seleccionado, pedir que lo seleccione
            if (!destinationCoords && !destination) {
                showNotification('Por favor, selecciona primero tu destino en el mapa', 'warning');
                startDestinationSelection();
                return;
            }

            const serviceRequest = {
                userId: currentUser.id,
                action: 'request',
                targetDriverId: driverId,
                lat: currentUser.lat,
                lng: currentUser.lng,
                destinationLat: destinationCoords?.lat,
                destinationLng: destinationCoords?.lng,
                destination: destination || 'Destino seleccionado en el mapa',
                description: document.getElementById('description').value.trim(),
                driverLat: driverData.lat,
                driverLng: driverData.lng,
                timestamp: Date.now()
            };

            // Establecer chat con el conductor
            chatPartner = {
                id: driverId,
                type: 'driver'
            };
            updateChatButton();

            // Enviar mensaje directo al conductor
            const directMessage = {
                targetId: driverId,
                senderId: currentUser.id,
                message: `Cliente te solicita servicio a: ${serviceRequest.destination}`,
                type: 'service_request',
                data: serviceRequest
            };

            publishMessage(MQTT_CONFIG.topics.messages, directMessage);

            currentUser.status = 'requesting';
            currentRequest = serviceRequest;
            updateUI();
            updateFABs();

            showNotification(`Solicitud enviada al conductor ${driverId}`, 'success');

            // Abrir chat autom√°ticamente
            openChat();
            addSystemMessage(`Has solicitado servicio al conductor. Puedes chatear mientras esperas respuesta.`);
        }

        // Dibujar ruta asignada (para conductor)
        function drawAssignedRoute(clientLocation, destination) {
            if (routeControl) {
                map.removeControl(routeControl);
            }

            const waypoints = [
                L.latLng(currentUser.lat, currentUser.lng),
                L.latLng(clientLocation.lat, clientLocation.lng)
            ];

            if (destination) {
                waypoints.push(L.latLng(destination.lat, destination.lng));
            }

            routeControl = L.Routing.control({
                waypoints: waypoints,
                routeWhileDragging: false,
                addWaypoints: false,
                createMarker: function () { return null; },
                lineOptions: {
                    styles: [{ color: '#28a745', weight: 5, opacity: 0.7 }]
                }
            }).on('routesfound', function (e) {
                const bounds = L.latLngBounds(waypoints);
                map.fitBounds(bounds, { padding: [50, 50] });
            }).addTo(map);
        }

        // Publicar mensaje MQTT
        function publishMessage(topic, data) {
            if (mqttClient && mqttClient.isConnected()) {
                const message = new Paho.MQTT.Message(JSON.stringify(data));
                message.destinationName = topic;
                mqttClient.send(message);
                console.log('Mensaje enviado a', topic, data);
            } else {
                console.error('Cliente MQTT no conectado');
                showNotification('Error de conexi√≥n. Reintentando...', 'error');
            }
        }

        // Agregar o actualizar marcador en el mapa
        function addOrUpdateMarker(data, type) {
            const markerId = data.userId;

            // Remover marcador existente si existe
            if (markers.has(markerId)) {
                map.removeLayer(markers.get(markerId));
            }

            // Determinar clase CSS seg√∫n el tipo
            let markerClass = '';
            if (markerId === currentUser.id) {
                markerClass = 'my-marker';
            } else if (type === 'client') {
                markerClass = 'client-marker';
            } else if (type === 'driver') {
                markerClass = 'driver-marker';
            }

            // Crear icono personalizado
            const iconHtml = `
                <div class="marker-icon ${markerClass}">
                    <div class="orientation-arrow"></div>
                </div>
            `;

            const customIcon = L.divIcon({
                html: iconHtml,
                className: 'custom-div-icon',
                iconSize: [40, 55], // Tama√±o mayor para incluir la flecha
                iconAnchor: [20, 55], // El ancla en la punta de la flecha
                popupAnchor: [0, -55] // Posici√≥n del popup arriba del marcador
            });

            // Crear marcador
            const marker = L.marker([data.lat, data.lng], {
                icon: customIcon,
                userData: { ...data, type }
            }).addTo(map);

            // Crear popup con informaci√≥n
            let popupContent = `
    <div style="min-width: 200px;">
        <h4>${type === 'client' ? 'üôã‚Äç‚ôÇÔ∏è Cliente' : 'üèçÔ∏è Mototaxista'}</h4>
             <p><strong>ID:</strong> ${data && data.userId ? data.userId.substring(0, 8) : 'N/A'}</p>


        <p><strong>Hora:</strong> ${new Date(data.timestamp).toLocaleTimeString()}</p>
`;

            if (type === 'client') {
                popupContent += `
        ${data.destination ? `<p><strong>Destino:</strong> ${data.destination}</p>` : ''}
        ${data.description ? `<p><strong>Detalles:</strong> ${data.description}</p>` : ''}
        <div style="margin-top: 10px; display: flex; gap: 5px; flex-wrap: wrap;">
            <button onclick="acceptClientRequest('${data.userId}')"
                style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                ‚úÖ Aceptar
            </button>
            <button onclick="initiateContact('${data.userId}', 'client')"
                style="background: #17a2b8; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                üí¨ Chatear
            </button>

        </div>
    `;
            } else if (type === 'driver') {
                // Contenido para conductores (mantener el existente)
                popupContent += `
        ${data.description ? `<p><strong>Descripci√≥n:</strong> ${data.description}</p>` : ''}
        ${data.price ? `<p><strong>Precio:</strong> S/ ${data.price}</p>` : ''}
    `;
            }

            popupContent += '</div>';
            if (type === 'client' && data.destination) {
                popupContent += `<p><strong>Destino:</strong> ${data.destination}</p>`;
            }

            if (data.description) {
                popupContent += `<p><strong>Descripci√≥n:</strong> ${data.description}</p>`;
            }

            if (type === 'driver' && data.price) {
                popupContent += `<p><strong>Precio:</strong> S/ ${data.price}</p>`;
            }

            // Bot√≥n de contacto para todos los usuarios excepto uno mismo
            if (currentUser.id !== data.userId) {
                popupContent += `
                    <button onclick="initiateContact('${data.userId}', '${type}')" class="contact-btn">
                        üí¨ Contactar
                    </button>
                `;
            }

            popupContent += '</div>';
            marker.bindPopup(popupContent);

            // Guardar referencia del marcador
            markers.set(markerId, marker);

            // Si es el usuario actual, abrir popup autom√°ticamente
            if (markerId === currentUser.id) {
                marker.openPopup();
            }
        }

        // Remover marcador
        function removeMarker(markerId) {
            if (markers.has(markerId)) {
                map.removeLayer(markers.get(markerId));
                markers.delete(markerId);
            }
        }

        // Agregar a lista de solicitudes
        function addToRequestsList(data, type) {
            const requestsList = document.getElementById('requestsList');
            const existingItem = document.getElementById(`request_${data.userId}`);

            if (existingItem) {
                existingItem.remove();
            }

            const distance = calculateDistance(
                currentUser.lat, currentUser.lng,
                data.lat, data.lng
            );

            const requestItem = document.createElement('div');
            requestItem.className = `request-item ${type}`;
            requestItem.id = `request_${data.userId}`;
            requestItem.dataset.requestData = JSON.stringify(data);

            let content = `
                <h4>${type === 'client' ? 'üôã‚Äç‚ôÇÔ∏è Cliente' : 'üèçÔ∏è Mototaxista'}
                    <span class="distance-badge">${distance.toFixed(1)} km</span>
                </h4>
                <p>üìç ${data.lat.toFixed(4)}, ${data.lng.toFixed(4)}</p>
                <p>üïí ${new Date(data.timestamp).toLocaleTimeString()}</p>
            `;

            if (type === 'client' && data.destination) {
                content += `<p>üéØ ${data.destination}</p>`;
            }

            if (data.description) {
                content += `<p>üí¨ ${data.description}</p>`;
            }

            if (type === 'driver' && data.price) {
                content += `<p>üí∞ S/ ${data.price}</p>`;
            }

            // Botones de acci√≥n
            if (currentUser.type !== type && currentUser.id !== data.userId && currentUser.status === 'waiting') {
                content += `
                    <button class="accept-btn">
                        ${type === 'client' ? 'Aceptar' : 'Solicitar'}
                    </button>
                    <button class="contact-btn" onclick="initiateContact('${data.userId}', '${type}')">
                        üí¨ Contactar
                    </button>
                `;
            }

            requestItem.innerHTML = content;

            // Insertar ordenado por distancia
            const items = requestsList.querySelectorAll('.request-item');
            let inserted = false;

            for (let item of items) {
                const itemData = JSON.parse(item.dataset.requestData);
                const itemDistance = calculateDistance(
                    currentUser.lat, currentUser.lng,
                    itemData.lat, itemData.lng
                );

                if (distance < itemDistance) {
                    requestsList.insertBefore(requestItem, item);
                    inserted = true;
                    break;
                }
            }

            if (!inserted) {
                requestsList.appendChild(requestItem);
            }
        }

        // Remover de lista de solicitudes
        function removeFromRequestsList(userId) {
            const item = document.getElementById(`request_${userId}`);
            if (item) {
                item.remove();
            }
        }

        // Manejar aceptaci√≥n del conductor
        function handleDriverAcceptance(data) {
            if (data.targetId === currentUser.id) {
                showNotification('¬°Un conductor acept√≥ tu solicitud!', 'success');
                currentUser.status = 'matched';
                updateUI();
                updateFABs();
            }
        }

        // Manejar mensajes de rutas
        function handleRouteMessage(data) {
            // Implementar actualizaci√≥n de rutas en tiempo real si es necesario
        }

        // Manejar mensajes directos
        function handleDirectMessage(data) {
            if (data.targetId === currentUser.id) {
                if (data.type === 'chat') {
                    // Mensaje de chat
                    handleChatMessage(data);
                } else {
                    // Otros tipos de mensajes
                    showNotification(data.message, data.type || 'info');

                    // Si es una solicitud cercana, resaltar en el mapa
                    if (data.type === 'nearby_request' && data.data) {
                        highlightRequest(data.data);
                    }

                    // Si es una solicitud de contacto
                    if (data.type === 'contact_request') {
                        handleContactRequest(data);
                    }
                }
            }
        }

        // Iniciar contacto con otro usuario
        window.initiateContact = function (userId, userType) {
            const targetUser = {
                id: userId,
                type: userType
            };

            // Verificar si ya hay un chat activo
            if (chatPartner && chatPartner.id === userId) {
                openChat();
                return;
            }

            // Establecer nuevo chat
            chatPartner = targetUser;
            chatMessages = [];

            // Enviar solicitud de contacto
            const contactRequest = {
                targetId: userId,
                senderId: currentUser.id,
                senderType: currentUser.type,
                message: `${currentUser.type === 'client' ? 'Cliente' : 'Taxista'} ${currentUser.id} quiere contactarte`,
                type: 'contact_request',
                timestamp: Date.now()
            };

            publishMessage(MQTT_CONFIG.topics.messages, contactRequest);

            // Abrir chat
            openChat();

            // Agregar mensaje de sistema
            addSystemMessage('Chat iniciado. Puedes enviar mensajes al ' +
                (userType === 'client' ? 'cliente' : 'taxista'));
        };

        // Manejar solicitud de contacto
        function handleContactRequest(data) {
            if (!chatPartner || chatPartner.id !== data.senderId) {
                chatPartner = {
                    id: data.senderId,
                    type: data.senderType
                };
                chatMessages = [];
            }

            // Mostrar bot√≥n de chat si no est√° visible
            updateChatButton();

            // Incrementar contador de mensajes no le√≠dos
            if (!document.getElementById('chatContainer').classList.contains('active')) {
                unreadMessages++;
                updateUnreadIndicator();
            }
        }

        // Manejar mensaje de chat
        function handleChatMessage(data) {
            if (data.senderId === chatPartner?.id) {
                const message = {
                    id: Date.now(),
                    senderId: data.senderId,
                    text: data.text,
                    timestamp: data.timestamp,
                    type: 'received'
                };

                chatMessages.push(message);

                if (document.getElementById('chatContainer').classList.contains('active')) {
                    displayMessage(message);
                    scrollToBottom();
                } else {
                    unreadMessages++;
                    updateUnreadIndicator();
                }

                // Sonido de notificaci√≥n
                playNotificationSound();
            }
        }

        // Abrir chat
        window.openChat = function () {
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.classList.add('active');

            // Actualizar nombre del chat
            const partnerType = chatPartner.type === 'client' ? 'Cliente' : 'Taxista';
            document.getElementById('chatPartnerName').textContent = `${partnerType} ${chatPartner.id.substring(0, 6)}`;

            // Limpiar mensajes no le√≠dos
            unreadMessages = 0;
            updateUnreadIndicator();

            // Mostrar mensajes existentes
            displayAllMessages();

            // Focus en input
            document.getElementById('chatInput').focus();

            toggleFABMenu(); // Cerrar men√∫ FAB si est√° abierto
        };

        // Cerrar chat
        window.closeChat = function () {
            document.getElementById('chatContainer').classList.remove('active');
        };

        // Enviar mensaje de chat
        window.sendChatMessage = function () {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();

            if (!text || !chatPartner) return;

            const message = {
                id: Date.now(),
                senderId: currentUser.id,
                text: text,
                timestamp: Date.now(),
                type: 'sent'
            };

            // Agregar a mensajes locales
            chatMessages.push(message);
            displayMessage(message);
            scrollToBottom();

            // Enviar por MQTT
            const chatData = {
                targetId: chatPartner.id,
                senderId: currentUser.id,
                text: text,
                type: 'chat',
                timestamp: message.timestamp
            };

            publishMessage(MQTT_CONFIG.topics.messages, chatData);

            // Limpiar input
            input.value = '';
        };

        // Manejar tecla Enter en chat
        window.handleChatKeyPress = function (event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        };

        // Mostrar mensaje en el chat
        function displayMessage(message) {
            const messagesContainer = document.getElementById('chatMessages');

            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${message.type}`;

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = `message-bubble ${message.type}`;

            const textP = document.createElement('p');
            textP.style.margin = '0';
            textP.textContent = message.text;

            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = new Date(message.timestamp).toLocaleTimeString();

            bubbleDiv.appendChild(textP);
            bubbleDiv.appendChild(timeDiv);
            messageDiv.appendChild(bubbleDiv);

            messagesContainer.appendChild(messageDiv);
        }

        // Mostrar todos los mensajes
        function displayAllMessages() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';

            chatMessages.forEach(message => {
                displayMessage(message);
            });

            scrollToBottom();
        }

        // Agregar mensaje del sistema
        function addSystemMessage(text) {
            const message = {
                id: Date.now(),
                senderId: 'system',
                text: text,
                timestamp: Date.now(),
                type: 'received'
            };

            chatMessages.push(message);

            if (document.getElementById('chatContainer').classList.contains('active')) {
                displayMessage(message);
                scrollToBottom();
            }
        }

        // Scroll al final del chat
        function scrollToBottom() {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Actualizar bot√≥n de chat
        function updateChatButton() {
            const fabChat = document.getElementById('fabChat');

            if (chatPartner) {
                fabChat.classList.add('show');
            } else {
                fabChat.classList.remove('show');
            }

            updateFABs();
        }

        // Actualizar indicador de mensajes no le√≠dos
        function updateUnreadIndicator() {
            const indicator = document.getElementById('unreadIndicator');

            if (unreadMessages > 0) {
                indicator.style.display = 'flex';
                indicator.textContent = unreadMessages > 9 ? '9+' : unreadMessages;
            } else {
                indicator.style.display = 'none';
            }
        }

        // Reproducir sonido de notificaci√≥n
        function playNotificationSound() {
            // Crear un simple beep usando Web Audio API
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 800;
                gainNode.gain.value = 0.1;

                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.1);
            } catch (e) {
                console.log('No se pudo reproducir sonido:', e);
            }
        }

        // Resaltar solicitud en el mapa
        function highlightRequest(requestData) {
            const marker = markers.get(requestData.userId);
            if (marker) {
                marker.openPopup();
                // Agregar efecto visual temporal
                const element = marker.getElement();
                if (element) {
                    element.classList.add('pulse');
                    setTimeout(() => {
                        element.classList.remove('pulse');
                    }, 5000);
                }
            }
        }

        // Manejar finalizaci√≥n de viaje
        function handleTripCompletion(data) {
            activeAssignment = null;
            currentUser.status = 'waiting';
            currentRequest = null;
            chatPartner = null;
            chatMessages = [];

            // Limpiar mapa
            clearRoute();

            // Recargar marcadores
            markers.forEach((marker, markerId) => {
                if (markerId !== currentUser.id) {
                    map.removeLayer(marker);
                }
            });
            markers.clear();
            markers.set(currentUser.id, markers.get(currentUser.id));

            updateUI();
            updateFABs();
            closeChat();
            showNotification('Viaje completado', 'success');
        }

        // Actualizar interfaz de usuario
        function updateUI() {
            const userTypeSelect = document.getElementById('userTypeSelect');
            const formTitle = document.getElementById('formTitle');
            const priceGroup = document.getElementById('priceGroup');
            const userId = document.getElementById('userId');
            const userStatus = document.getElementById('userStatus');

            // Actualizar informaci√≥n del usuario
            userId.textContent = currentUser.id.substring(0, 8);
            userStatus.textContent = getStatusText(currentUser.status);

            // Deshabilitar cambio de tipo durante viaje
            userTypeSelect.disabled = currentUser.status === 'in_trip' || currentUser.status === 'requesting';

            // Actualizar seg√∫n tipo de usuario
            if (currentUser.type === 'client') {
                formTitle.textContent = 'Solicitar Taxi';
                priceGroup.style.display = 'none';
            } else {
                formTitle.textContent = 'Ofrecer Servicio';
                priceGroup.style.display = 'block';
            }

            // Deshabilitar controles durante viaje
            if (currentUser.status === 'in_trip' || currentUser.status === 'requesting') {
                document.getElementById('destination').disabled = true;
                document.getElementById('description').disabled = true;
                document.getElementById('price').disabled = true;
            } else {
                document.getElementById('destination').disabled = false;
                document.getElementById('description').disabled = false;
                document.getElementById('price').disabled = false;
            }
        }

        // Obtener texto de estado
        function getStatusText(status) {
            const statusTexts = {
                'waiting': '‚è≥ Esperando',
                'requesting': 'üöï Solicitando taxi',
                'available': 'üèçÔ∏è Disponible',
                'matched': '‚úÖ Emparejado',
                'in_trip': 'üöó En viaje'
            };
            return statusTexts[status] || status;
        }

        // Actualizar estado de conexi√≥n
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (connected) {
                statusEl.className = 'connection-status connected';
                statusEl.textContent = 'üü¢ Conectado a ChasquiX';
            } else {
                statusEl.className = 'connection-status disconnected';
                statusEl.textContent = 'üî¥ Desconectado';
            }
        }

        // Mostrar notificaci√≥n
        function showNotification(message, type = 'info') {
            // Crear elemento de notificaci√≥n
            const notification = document.createElement('div');
            notification.className = 'notification';

            // Colores seg√∫n tipo
            const colors = {
                'success': '#28a745',
                'error': '#dc3545',
                'warning': '#ffc107',
                'info': '#17a2b8'
            };

            notification.style.backgroundColor = colors[type] || colors.info;
            notification.textContent = message;

            document.body.appendChild(notification);

            // Animaci√≥n de entrada
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            // Remover despu√©s de 4 segundos
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

        // Calcular distancia entre dos puntos (f√≥rmula de Haversine)
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Radio de la Tierra en km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // Actualizar ubicaci√≥n en tiempo real (cada 30 segundos)
        function startLocationTracking() {
            setInterval(() => {
                if (navigator.geolocation && (currentUser.status === 'available' || currentUser.status === 'in_trip')) {
                    navigator.geolocation.getCurrentPosition(
                        function (position) {
                            const newLat = position.coords.latitude;
                            const newLng = position.coords.longitude;

                            // Solo actualizar si la posici√≥n cambi√≥ significativamente
                            const distance = calculateDistance(currentUser.lat, currentUser.lng, newLat, newLng);
                            if (distance > 0.01) { // ~10 metros
                                updateLocation(newLat, newLng);

                                // Publicar nueva ubicaci√≥n si est√° activo
                                if (currentRequest) {
                                    const locationUpdate = {
                                        ...currentRequest,
                                        lat: newLat,
                                        lng: newLng,
                                        timestamp: Date.now()
                                    };

                                    const topic = currentUser.type === 'client' ?
                                        MQTT_CONFIG.topics.clients : MQTT_CONFIG.topics.drivers;

                                    publishMessage(topic, locationUpdate);
                                }
                            }
                        },
                        function (error) {
                            console.log('Error obteniendo ubicaci√≥n:', error);
                        }
                    );
                }
            }, 30000); // 30 segundos
        }

        // Iniciar seguimiento de ubicaci√≥n al cargar
        setTimeout(startLocationTracking, 5000);

        // Limpiar al cerrar la ventana
        window.addEventListener('beforeunload', function () {
            if (currentRequest) {
                cancelCurrentRequest();
            }
            if (mqttClient && mqttClient.isConnected()) {
                mqttClient.disconnect();
            }
        });



    </script>
</body>

</html>
